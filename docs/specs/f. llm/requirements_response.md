
# Ответы на уточняющие вопросы по реализации LLM-пакета анонимизации

Документ содержит конкретизированные ответы на вопросы по архитектуре и требованиям, основанные на текущей реализации (`operations.md`, `nlp.md`, `io.md`, `progress.py`, `logging.py`).

---

## 1. Интеграция с существующей структурой

### 1.1 Глубина интеграции

Новый пакет должен:
- Наследоваться от `pamola_core.utils.ops.op_base.BaseOperation` или `FieldOperation`.
- Использовать регистрацию операций через `register_operation`.
- Использовать инфраструктурные модули:
  - `pamola_core.utils.io`: `load_dataframe`, `save_dataframe`
  - `pamola_core.utils.nlp`: `tokenize_text`, `detect_language`, `extract_named_entities`
  - `progress.py`: `ProgressTracker`, `track_operation`, `process_dataframe_in_chunks`
  - `logging.py`: `configure_task_logging`, `get_logger`
  - `visualization.py`: (при необходимости)

### 1.2 Приоритетные компоненты

- `pamola_core.utils.ops`
- `pamola_core.utils.io`
- `pamola_core.utils.nlp`
- `progress.py`
- `logging.py`

---

## 2. LLM-провайдеры

- Используем только **локальный LM Studio** в режиме API.
- Прямая интеграция через `llama.cpp`, `transformers` — **не поддерживается**.
- Возможна работа с **несколькими LM Studio-нодами** по сети.

---

## 3. Управление промптами

### 3.1 Промпты в JSON

- Расположение: `DATA/external_dictionaries/llm/prompts/`
- Формат:
```json
{
  "template": "Анонимизируй следующий текст: {{text}}",
  "system": "Ты специалист по анонимизации...",
  "lang": "ru"
}
```

### 3.2 Шаблоны с переменными

- Использование `{{text}}`, `{{field}}`, `{{name}}` — планируется через `str.format` или `jinja2`.
- Начнем с простого подстановочного механизма.

---

## 4. Обработка данных

### 4.1 Объем

- До 180 000 записей.

### 4.2 Асинхронность

- Используются чанки (`iterate_dataframe_chunks`).
- `asyncio` — не используется, но возможна параллельная обработка через многонодную маршрутизацию.

### 4.3 Ограничения API

- Ограничения только по объему текста.
- Поддерживается восстановление с последнего ID / строки.

---

## 5. Анонимизация

### 5.1 Типы данных

- Имена, должности, организации, адреса, даты, мероприятия.

### 5.2 Уровни анонимизации

- Первый этап — задается промптом.
- Второй этап — NER и уровень управляется параметром (`partial`, `full`).

---

## 6. Технический стек

- Python 3.11+
- Библиотеки: `pandas`, `tqdm`, `psutil`, `requests`, (`jinja2` опционально)

---

## 7. Контроль процессов

- Используются `ProgressTracker`, `track_operation`
- Метрики: прогресс, время, память, чанки.
- Логи на уровне задач: `configure_task_logging(task_dir)`

---

## 8. Прерывание и восстановление

- Резюмирование возможно по номеру строки или ID.
- Поддержка логов и checkpoint'ов для восстановления.

---

## 9. Таймлайн

### Этап 1 (MVP)
- LM Studio API
- Однотипная операция анонимизации
- I/O, логирование, прогресс

### Этап 2
- NER, categorization
- Гибкие шаблоны
- Уровни анонимизации

### Этап 3
- Поддержка мульти-ноды
- Расширенные метрики и контроль
- Retry, resume

---

# Дополнительные уточнения

## 10. Требования к формату возвращаемых данных от LLM

- Ответы LLM должны быть обработаны внутри операции, которая получает входной DataFrame и имя поля.
- Результат может:
  - Заменять оригинальное значение в переданном поле;
  - Добавляться как дополнительный столбец (`<field>_anonymized`);
  - Возвращать также использованный промпт (опционально).
- Формат возвращаемого результата — `DataFrame` или `.csv`, в зависимости от режима.
- Косинусное сходство между оригинальным и новым текстом (векторизация через NLP-модуль) может использоваться для оценки изменений.
- Артефакты процесса (PNG, JSON) формируются через `visualization.py`.

## 11. Журналирование операций LLM

- Используется стандартная система логирования (`configure_task_logging`).
- Дополнительно сохраняются:
  - Время ответа;
  - Признаки некорректных/пустых ответов;
  - Косинусное сходство (если векторизация включена);
  - Название модели и параметров.

## 12. Обработка ошибок

- При ошибке от API:
  - Повторить до N раз;
  - Зафиксировать в логе с кодом и телом ответа.
- При неполном или "нелепом" ответе:
  - Использовать векторизацию + порог по косинусной близости;
  - Опционально — fallback к шаблону или сохранение пустого значения.

## 13. Многоязычные тексты

- Могут быть смешанными.
- Пользователь может указать предпочтительный язык (`lang`).
- Автоопределение реализуется через `pamola_core.utils.nlp.detect_language`.

## 14. Приоритетные метрики качества

- **Метрики процесса** (первый этап):
  - Количество обработанных строк;
  - Кол-во пустых/пропущенных/ошибочных;
  - Время обработки;
  - Кол-во вызовов к LLM;
- **Метрики качества анонимизации** — реализуются позже, отдельным этапом.


---

## 15. Примеры промптов

### Пример JSON-шаблона промпта:
```json
{
  "system": "Ты специалист по анонимизации...",
  "template": "Анонимизируй следующий текст: {{text}}",
  "lang": "ru"
}
```

- Допускается использование переменных: `{{text}}`, `{{name}}`, `{{field}}`
- Хранение: `DATA/external_dictionaries/llm/prompts/*.json`

---

## 16. Метрики процесса и визуализация

### Метрики:
- Общее число записей
- Обработано / пропущено / с ошибками
- Время ответа от LLM (avg, max)
- Количество запросов
- Количество токенов
- Косинусное сходство (если включено):
  - Среднее значение
  - Стандартное отклонение
  - Минимум / максимум

### Артефакты:
- `metrics.json` — агрегированные показатели
- `difference_plot.png` — визуализация замен
- `similarity_histogram.png` — (опционально)

---

## 17. Модуль векторизации (расширение pamola_core.utils.nlp)

```python
# pamola_core/utils/nlp/vectorizer.py

def vectorize_text(text: str) -> np.ndarray:
    ...

def cosine_similarity(vec1: np.ndarray, vec2: np.ndarray) -> float:
    ...
```

- Используется FastText или SentenceTransformer
- Опционально: пакетная обработка
- Вспомогательные методы — для сравнения оригинального и анонимизированного текста

---

## 18. Структура пакета и запуск задач

### Модули первой очереди:
- `pamola_core.utils.ops.op_llm_anonymizer.py`
- `pamola_core.utils.io`
- `pamola_core.utils.nlp`
- `pamola_core.utils.progress`
- `pamola_core.utils.logging`

### Модули второй очереди:
- `pamola_core.utils.visualization`
- `pamola_core.utils.nlp.vectorizer` (новый)

### Внешний запуск:
- Все пути (входной файл, модель, промпт, параметры) задаются извне в `task_config.json`
- Операция сохраняет результат в: `{task_dir}/output/{dataset_name}.csv`
- Метрики и визуализация: `{task_dir}/metrics.json`, `{task_dir}/difference_plot.png`

---

## 19. Дополнительные уточнения

- Операция возвращает либо `DataFrame`, либо сохраняет CSV.
- Отображение результата в `field_name_anonymized` или перезапись.
- Поведение определяется конфигурацией задачи.

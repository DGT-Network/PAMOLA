# Уточненный план рефакторинга системы конфигурации и путей PAMOLA Core

## Этап 1: Модернизация системы конфигурации

### 1.1 Комплексное обновление `task_config.py` и создание `project_config_loader.py`
- **Обнаружение корня проекта:**
  - Реализовать поиск по приоритетам: `PAMOLA_PROJECT_ROOT` → `.pamolaProject` → Git-корень → текущий каталог (с предупреждением)
  - Кэшировать найденный корень для повторного использования
- **Поддержка YAML для проекта:**
  - Стандартизировать расширение `.yaml` (не `.yml`) для проектных конфигураций
  - Создать `project_config_loader.py` для работы с YAML и кэширования разобранных конфигураций
  - Реализовать подстановку переменных с помощью jinja2
- **API путей:**
  - Определить фиксированные суффиксы (`input/`, `output/`, `temp/`, `logs/`, `dictionaries/`) в самом TaskConfig
  - Реализовать полный набор helper-методов:
    ```python
    get_project_root()
    get_data_repository()
    get_raw_dir()
    get_processed_dir()
    get_reports_dir()
    get_task_dir(task_id=None)
    get_task_input_dir(task_id=None)
    get_task_output_dir(task_id=None)
    get_task_temp_dir(task_id=None)
    get_task_logs_dir(task_id=None)
    get_task_dict_dir(task_id=None)
    ```
  - Кэшировать результаты для ускорения повторных вызовов
- **Каскадирование конфигураций:**
  - CLI-аргументы → задача → проект → значения по умолчанию
  - Обеспечить явную запись источника каждого параметра для отладки

### 1.2 Создание `path_security.py`
- **Проверки безопасности:**
  - Блокировать выход за пределы репозитория и проекта
  - Валидировать абсолютные пути (только разрешенные директории)
  - Реализовать белый список разрешенных внешних абсолютных путей
  - Учесть Windows-символические ссылки и UNC-пути (`\\server\...`)
- **Обработка ошибок:**
  - Создать класс `PathSecurityError` с детальными сообщениями
  - Реализовать режим со строгими проверками (по умолчанию) и режим с предупреждениями

## Этап 2: Обновление основных компонентов

### 2.1 Обновление `BaseTask`
- **Интеграция с новой конфигурацией:**
  - Использовать API путей вместо прямого конструирования
  - Автоматически создавать подкаталоги (`input/`, `output/`, `temp/`, `logs/`) внутри `task_dir` при `initialize()`
  - Писать логи задачи в `task_dir/logs`, а root-лог оставить агрегирующим
- **Передача параметров операциям:**
  - Автоматически передавать флаги `use_encryption`, `encryption_mode`, `use_dask` операциям
  - Обеспечить доступ к конфигурации через стандартизованный интерфейс

### 2.2 Создание `dependency_manager.py`
- **Функции для работы с зависимостями:**
  - `get_dependency_output(dependency_id, file_pattern=None)`
  - `get_dependency_report(dependency_id)`
  - `assert_dependencies_completed()` - проверка наличия *report.json* из предыдущей задачи
- **Обработка различных форматов:**
  - Поддержка абсолютных путей: если `dependency_id` содержит `:`, трактовать как полный путь
  - Иначе интерпретировать как task_id (относительный путь к другой задаче)
- **Проверки и ошибки:**
  - Проверки существования зависимостей
  - Информативные ошибки при отсутствии необходимых зависимостей

### 2.3 Обновление существующих задач (в координации с Titan)
- Обновить существующие задачи для использования нового API
- Заранее согласовать с Titan список всех скриптов, требующих обновления
- Обновить конструкторы операций, которые вручную формируют пути (`profiling/analyzers/group.py`, `anonymization/operations/...`)

### 2.4 Обновление I/O и операций
- Обновить `pamola_core/utils/io_helpers.py` для использования параметров из конфигурации (encoding, delimiter, quotechar)
- Модифицировать `pamola_core/utils/ops/op_registry.py` для корректной передачи encryption/dask флагов

## Этап 3: Тестирование и документация

### 3.1 Создание модульных тестов
- **Тесты конфигурации:**
  - Обнаружение корня проекта в разных условиях
  - Загрузка и парсинг YAML и JSON
  - Подстановка переменных
  - Каскадирование параметров с различными приоритетами
  - Тестирование конфиг-override через CLI (`--data-repo /tmp/data_alt`, `--log-level DEBUG`)
- **Тесты безопасности путей:**
  - Создать parametrized-тест с 10-15 паттернами (`.`, `..`, симлинки, UNC, `$HOME`, и т.д.)
  - Тестировать как положительные, так и отрицательные кейсы
- **Тесты API путей:**
  - Корректное разрешение различных типов путей
  - Создание и управление директориями
  - Работа с зависимостями

### 3.2 Создание интеграционных тестов
- Тестирование полного жизненного цикла задачи
- Тесты запуска из разных рабочих директорий
- Валидация реальной структуры проекта
- Тестирование интеграции с операциями

### 3.3 Обновление документации
- Руководство по новому API путей
- Документирование структуры конфигурации
- Примеры создания новых задач
- Руководство по безопасности путей

## Этап 4: Разработка вспомогательных инструментов

### 4.1 Создание утилит для проекта
- Утилита для проверки и исправления структуры проекта
- Инструмент валидации конфигурации
- Генератор шаблонов для новых задач
- Интеграция утилиты проверки в GitHub Actions/GitLab CI

### 4.2 Обновление CLI-интерфейсов
- Обновить `scripts/task_runner.py` для работы с новой конфигурацией
- Обновить `scripts/pipeline_run.py` с учетом новой системы зависимостей
- Обеспечить правильную передачу флагов и параметров

## Модули, требующие изменения (минимальный перечень)

### Конфигурация
- `pamola_core/utils/task_config.py` (полностью переработать)
- `pamola_core/utils/project_config_loader.py` (новый)

### Безопасность путей
- `pamola_core/utils/path_security.py` (новый)

### Базовый фреймворк
- `pamola_core/utils/base_task.py` (обновить для использования нового API)
- `pamola_core/utils/tasks/dependency_manager.py` (новый)

### Операции
- Конструкторы операций, которые вручную формируют пути (`profiling/analyzers/group.py`, `anonymization/operations/...`)

### I/O
- `pamola_core/utils/io_helpers.py` – обновить для использования параметров из конфигурации

### Реестр операций
- `pamola_core/utils/ops/op_registry.py` – обновить для передачи encryption/dask флагов

### CLI / Launcher
- `scripts/task_runner.py`
- `scripts/pipeline_run.py`

Этот план учитывает все указанные вами корректировки и дополнения, обеспечивая четкую последовательность действий для успешного рефакторинга системы конфигурации и путей в PAMOLA Core.
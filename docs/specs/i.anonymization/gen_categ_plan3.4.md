### Рекомендуемый порядок работ — **от «фундамента» к фасаду**

> Ниже предложена последовательность файлов/обновлений так, чтобы
> – в каждый момент репозиторий собирался,
> – не возникало циклов импорта,
> – можно было прогонять unit-тесты инкрементально.
> (Ссылки на пункты плана — )

| Шаг         | Что делаем                                                                                                                                                                                                                                            | Зачем именно так                                                                 | Мини-зависимости                      |
| ----------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | ------------------------------------- |
| **0 - tag** | Создать ветку `feat/categ-refactor-v3` и зафиксировать текущую работающую версию (tag `categ-v2.2`)                                                                                                                                                   | откат на старое состояние в любой момент                                         | —                                     |
| **1**       | **commons/hierarchy\_dictionary.py**<br>  • добавить `@lru_cache` + `RLock`<br>  • публичный `file_hash()`                                                                                                                                            | самый низкий уровень; никто ещё от него не зависит                               | —                                     |
| **2**       | **commons/category\_mapping.py** (NEW)<br>  • класс `CategoryMappingEngine`<br>  • unit-тесты                                                                                                                                                         | нужен всем стратегиям; зависит только от `category_utils`/`hierarchy_dictionary` | шаг 1, существующий `category_utils`  |
| **3**       | **commons/category\_utils.py** - расширение<br>  • `collect_categorical_metrics` → удаляем, делегируем в `metric_utils`<br>  • `calculate_semantic_diversity_safe`, `identify_rare_categories`, …<br>  • **НЕ** добавлять `load_hierarchy_dictionary` | чтобы стратегии имели полный набор утилит; изменение не ломает текущий код       | шаг 1                                 |
| **4**       | **categorical\_config.py** (NEW)<br>  • класс `CategoricalGeneralizationConfig`<br>  • JSON-schema c новыми полями (`null_strategy`, `unknown_value`, `rare_value_template`, `engine`, …)                                                             | на него будет ссылаться фасад и GUI-валидатор                                    | шаг 3                                 |
| **5**       | **categorical\_strategies.py** (NEW)<br>  • `apply_hierarchy`, `apply_merge_low_freq`, `apply_frequency_based`<br>  • `apply_null_and_unknown_strategy`<br>  • пока **без** Dask-версий (можно TODO)                                                  | зависит от шагов 1–3                                                             | шаг 2 + 3                             |
| **6**       | **categorical\_op.py** (NEW фасад v3.0)<br>  • конструктор с config<br>  • `process_batch` делегирует в стратегии<br>  • `_collect_specific_metrics` — с `timing_info`<br>  • `reset_state`, `_get_cache_parameters`, визуализации, …                 | вершина графа; нужна вся низлежащая инфраструктура                               | шаг 4 + 5                             |
| **7**       | **generalization/**init**.py**<br>  • `from .categorical_op import CategoricalGeneralizationOperation, CategoricalGeneralizationConfig`                                                                                                               | чтобы старые импорты продолжили работать                                         | шаг 6                                 |
| **8**       | **categorical\_legacy.py** (proxy + DeprecationWarning)                                                                                                                                                                                               | плавная миграция; импортирует класс из шага 6                                    | шаг 6                                 |
| **9**       | **Обновить tests**<br>  • unit для `CategoryMappingEngine` (шаг 2)<br>  • unit для каждой стратегии (шаг 5)<br>  • integration-test фасада (шаг 6)                                                                                                    | тесты можно добавлять по мере появления кода                                     | предыдущие шаги                       |
| **10**      | **Документация** (`gen_categ.md`, Sphinx tags)                                                                                                                                                                                                        | завершает user-visible изменение                                                 | шаг 6                                 |
| **11**      | **Dask-ветка (optional)**<br>  • реализация `apply_*_dask`<br>  • переключатель в фасаде                                                                                                                                                              | изолированный доп-коммит; не влияет на «малые» наборы                            | зависит от шагов 5–6                  |
| **12**      | **Удалить legacy-модуль** (в следующем минорном релизе)                                                                                                                                                                                               | финальный cleanup                                                                | зависит от успешного развёртывания v3 |

---

#### Почему именно такой порядок?

1. **Никто** не ссылается выше своего уровня: *commons → strategies → фасад*.
2. Каждый шаг можно мерджить сразу после зелёного CI: код компилируется, старые тесты проходят (до шага 8 включительно сохраняется proxy).
3. Сначала создаётся/правится код, **не ломающий** существующую операцию v2 (шаги 1-4) → мастер остаётся зелён.
4. Новый фасад подключается **последним** (шаг 6), когда всё, что он импортирует, уже существует.

---

**Подсказка для реализации:**
если нужна ещё более мелкая гранулярность, можно разнести шаг 5 на три маленьких PR (по стратегии), но тогда придётся временно скрыть импорты неготовых функций во фасаде (feature flag). Обычно шаг 5 одним пул-реквестом проще.

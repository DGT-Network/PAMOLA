# Документация системы отчетности PAMOLA.CORE

## Назначение

Система отчетности PAMOLA.CORE (Privacy-Preserving AI Data Processors) предназначена для создания структурированных отчетов о выполнении задач по обработке, анализу и анонимизации данных резюме. Система обеспечивает:

- Единый интерфейс для просмотра результатов множества задач
- Корректное отображение артефактов (графики, таблицы, статистика)
- Визуализацию зависимостей между задачами
- Генерацию HTML-отчетов с интерактивными элементами
- Настройку метаданных проекта и описаний

## Состав системы

Система отчетности PAMOLA.CORE состоит из следующих компонентов:

1. **Модуль конфигурации** (`pamola_core.utils.reporting.config`)
2. **Модуль шаблонов** (`pamola_core.utils.reporting.template_engine`)
3. **Модуль зависимостей** (`pamola_core.utils.reporting.dependency_graph`)
4. **Модуль форматирования HTML** (`pamola_core.utils.reporting.html_formatter`)
5. **Интерфейсный модуль** (`pamola_core.utils.reporting.__init__`)
6. **Модуль отчетов задач** (`pamola_core.utils.task_reporting`)
7. **Пользовательский скрипт** (`scripts/report_formatter.py`)
8. **Шаблоны отчетов** (хранятся в директории `data/templates`)

## Основные функции модулей

### Модуль конфигурации (`config.py`)

**Назначение**: Управление настройками и конфигурацией системы отчетности.

**Основные функции**:
- `load_config()` - Загрузка конфигурации проекта
- `save_config()` - Сохранение конфигурации проекта
- `update_project_metadata()` - Обновление метаданных проекта
- `get_reporting_settings()` - Получение настроек отчетности
- `update_reporting_settings()` - Обновление настроек отчетности
- `get_task_dependencies()` - Получение зависимостей между задачами
- `update_task_dependencies()` - Обновление зависимостей между задачами
- `detect_task_type()` - Определение типа задачи на основе идентификатора

**Требования**:
- Модуль должен уметь работать с отсутствующим файлом конфигурации, используя значения по умолчанию
- Должен корректно обрабатывать пути к директориям шаблонов и отчетов
- Конфигурация должна поддерживать настройки проекта, отчетности и зависимостей задач

### Модуль шаблонов (`template_engine.py`)

**Назначение**: Работа с шаблонами отчетов, рендеринг HTML и копирование ресурсов.

**Основные функции**:
- `get_jinja_environment()` - Создание и настройка окружения Jinja2
- `render_template()` - Рендеринг шаблона с заданным контекстом
- `copy_static_resources()` - Копирование статических ресурсов шаблона
- `include_external_resources()` - Загрузка и сохранение внешних ресурсов
- `initialize_template()` - Инициализация шаблона - копирование стандартных файлов
- `list_available_templates()` - Получение списка доступных шаблонов

**Требования**:
- Должен корректно обрабатывать отсутствующие шаблоны и ресурсы
- Должен поддерживать создание относительных путей для артефактов
- Должен обеспечивать работу как с локальными ресурсами, так и с CDN

### Модуль зависимостей (`dependency_graph.py`)

**Назначение**: Обработка и визуализация зависимостей между задачами.

**Основные функции**:
- `get_all_tasks()` - Получение списка всех задач
- `resolve_dependencies()` - Разрешение зависимостей между задачами
- `check_circular_dependencies()` - Проверка наличия циклических зависимостей
- `topological_sort()` - Топологическая сортировка задач
- `enrich_tasks_with_dependencies()` - Обогащение отчетов задач информацией о зависимостях
- `create_dependency_graph_data()` - Создание данных для визуализации графа
- `create_dependency_graph_svg()` - Создание SVG-изображения графа зависимостей

**Требования**:
- Должен корректно обрабатывать отсутствующие зависимости
- Должен обнаруживать и обрабатывать циклические зависимости
- Должен поддерживать различные форматы визуализации зависимостей

### Модуль форматирования HTML (`html_formatter.py`)

**Назначение**: Создание HTML-отчетов на основе отчетов задач.

**Основные функции**:
- `prepare_task_reports()` - Подготовка отчетов задач для отображения
- `prepare_artifacts_for_report()` - Подготовка артефактов для отчета
- `create_dashboard_data()` - Создание данных для панели мониторинга
- `create_html_report()` - Создание HTML-отчета на основе отчетов задач
- `load_task_report()` - Загрузка отчета задачи из JSON-файла
- `load_all_task_reports()` - Загрузка всех отчетов задач из директории

**Требования**:
- Должен корректно обрабатывать различные типы артефактов
- Должен создавать относительные пути к артефактам
- Должен поддерживать категоризацию задач и артефактов
- Должен обеспечивать интерактивность отчета

### Интерфейсный модуль (`__init__.py`)

**Назначение**: Предоставление унифицированного интерфейса для работы с системой отчетности.

**Основные функции**:
- `generate_report()` - Генерация HTML-отчета на основе всех доступных отчетов задач
- `generate_report_for_tasks()` - Генерация HTML-отчета для указанных задач
- `install_templates()` - Установка стандартных шаблонов

**Требования**:
- Должен экспортировать основные функции из всех модулей
- Должен предоставлять простой и понятный интерфейс для пользователей
- Должен обрабатывать основные ошибки и предоставлять информативные сообщения

### Модуль отчетов задач (`task_reporting.py`)

**Назначение**: Создание и управление отчетами о выполнении отдельных задач.

**Основные функции**:
- `create_task_report()` - Создание нового отчета о выполнении задачи
- `update_task_operation()` - Добавление информации об операции в отчет
- `add_task_artifact()` - Добавление информации об артефакте в отчет
- `add_task_dependency()` - Добавление зависимости от другой задачи
- `complete_task_report()` - Завершение отчета о задаче
- `save_task_report()` - Сохранение отчета о выполнении задачи в JSON
- `load_task_report()` - Загрузка отчета о выполнении задачи из JSON
- `TaskReporter` - Класс для управления отчетами о задачах с использованием контекстного менеджера

**Требования**:
- Должен поддерживать регистрацию различных типов операций и артефактов
- Должен обрабатывать ошибки и исключения
- Должен сохранять информацию о зависимостях между задачами

### Пользовательский скрипт (`report_formatter.py`)

**Назначение**: Предоставление интерфейса командной строки для генерации отчетов.

**Основные функции**:
- Парсинг аргументов командной строки
- Генерация HTML-отчетов по запросу пользователя
- Установка шаблонов
- Настройка параметров отчетности

**Требования**:
- Должен поддерживать различные параметры командной строки
- Должен обрабатывать ошибки и предоставлять информативные сообщения
- Должен поддерживать фильтрацию задач и настройку отчетов

## Порядок генерации отчета

### Процесс генерации отчета после запуска задачи

1. **Инициализация отчета задачи**:
   - Создается отчет о задаче с указанием идентификатора, описания и зависимостей
   - Регистрируется информация о системе и времени запуска
   
2. **Выполнение задачи**:
   - В процессе выполнения задачи регистрируются операции и артефакты
   - Каждая операция имеет статус и дополнительные детали
   - Каждый артефакт имеет тип, путь и описание
   
3. **Завершение отчета задачи**:
   - После завершения задачи фиксируется итоговый статус
   - Рассчитывается время выполнения и использование памяти
   - Отчет сохраняется в JSON-файл в директории `data/reports`
   
4. **Генерация HTML-отчета** (если включена автогенерация):
   - Загружаются все доступные отчеты задач
   - Разрешаются зависимости между задачами
   - Подготавливаются артефакты и данные для панели мониторинга
   - Создается HTML-отчет на основе шаблона
   - Копируются необходимые ресурсы
   - Отчет сохраняется в директории `data/reports/html`
   - Опционально открывается в браузере

### Пример запуска

1. Пользователь запускает задачу профилирования:
   ```bash
   python scripts/profile_contacts.py --input data/raw/CONTACTS.csv --generate-html
   ```

2. Задача создает отчет и регистрирует операции и артефакты

3. После завершения задачи генерируется HTML-отчет:
   ```bash
   python scripts/report_formatter.py --reports-dir data/reports --open
   ```

4. HTML-отчет открывается в браузере, показывая результаты задачи и зависимости

## Зависимости между модулями

```
task_reporting.py
    |
    v
html_formatter.py
    |
    +-----> template_engine.py
    |           |
    |           v
    +-----> config.py
    |
    +-----> dependency_graph.py
                |
                v
             config.py
```

- **task_reporting.py** создает отчеты о задачах в формате JSON
- **html_formatter.py** загружает отчеты и создает HTML-отчеты
- **template_engine.py** обеспечивает рендеринг шаблонов и работу с ресурсами
- **dependency_graph.py** обрабатывает зависимости между задачами
- **config.py** управляет конфигурацией системы отчетности

## Модификация скриптов задач

Для работы с системой отчетности скрипты задач должны:

1. Использовать класс `TaskReporter` для создания отчета задачи
2. Регистрировать операции и артефакты через методы `add_operation()` и `add_artifact()`
3. Указывать зависимости от других задач при создании отчета
4. Обрабатывать ошибки и обновлять статус операций соответственно

Пример структуры скрипта задачи:

```python
def main(args):
    # Настройка логирования
    configure_logging(args.log)
    
    # Инициализация отчета задачи
    with TaskReporter("task_id", "Task Description", dependencies=["dep1", "dep2"]) as reporter:
        try:
            # Выполнение операций
            reporter.add_operation("Reading data")
            
            # Создание и регистрация артефактов
            reporter.add_artifact("json", "path/to/file.json", "Results")
            
        except Exception as e:
            reporter.add_operation("Processing", status="error", details={"error": str(e)})
            raise
```

## Заключение

Система отчетности PAMOLA.CORE предоставляет мощный инструмент для отслеживания выполнения задач, визуализации результатов и управления зависимостями. Она обеспечивает единый интерфейс для просмотра результатов различных задач и помогает пользователям отслеживать процесс обработки данных.